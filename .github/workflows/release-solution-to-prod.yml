name: release-solution-to-prod
on: 
 workflow_dispatch:
 release:
  types: [created]
permissions:
 contents: write
jobs:
 converted-to-managed:
  runs-on: windows-latest
  env:
   RUNNER_DEBUG: 1
  
  steps:
  - uses: action/checkout@v2
    with:
     lfs: true
     
  - name: pack solution
    uses: microsoft/powerplatform-actions/pack-solutions@v0
    with:
      solution-folder: solutions/ALMLab
      solution-file: out/solutions/ALMLab.zip
      solution-type: unmanaged
      
  - name: Import solution as unmanaged to build env
    uses: microsoft/powerplatform-actions/import-solution@v0
    with:
      environment-url: '<BUILD ENV URL>'
      user-name: '<USER NAME>'
      password-secret: ${{secrets.password}}
      solution-file: out/solutions/ALMLab.zip
      force-overwrite: true
      publish-changes: true
      
  - name: Export solution as managed
    uses: microsoft/powerplatform-actions/export-solution@v0
    with:
      environment-url: '<BUILD ENV URL>'
      user-name: '<USER NAME>'
      password-secret: ${{secrets.password}}
      solution-name: ALMLab
      managed: true
      solution-output-file: out/ship/ALMLab.zip
      
  - name: Upload the ready to ship soltuoon to GH artifact store
    uses: actions/upload-artifact@v2
    with:
      name: managedSolutions
      path: out/ship/ALMLab.zip
      
 release-to-staging:
    needs: [converted-to-managed]
    runs-on: windows-latest
    env:
      RUNNER_DEBUG: 1
    
    steps:
    - uses: actions/checkout@v2
      with:
        lfs: true
        
    - name: Fetch the ready to ship solution from GH artificat store 
      uses: actions/download-artificat@v2
      with:
        name: managedSolutions
        path: out/release/
        
    - name: Import soltuion to prod env
      uses: microsoft/powerplatform-actions/import-solution@v0
      with:
        envrionment-url: '<PROD ENV URL>'
        user-name: '<USER NAME>'
        password-secret: ${{secrets.password}}
        solution-file: out/release/ALMLab.zip
        force-overwrite: true
        publish-changes: true
    
    
